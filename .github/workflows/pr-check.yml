name: PR Check

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  pr-check:
    name: Lint, Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore
      run: dotnet restore

    # 🎨 FORMAT
    - name: Check formatting
      id: format
      run: |
        dotnet format --verify-no-changes --verbosity diagnostic
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 🏗️ BUILD
    - name: Build
      id: build
      run: |
        dotnet build --configuration Release --no-restore
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 🧪 UNIT TESTS
    - name: Unit Tests
      id: unit
      run: |
        dotnet test MotoNomad.Tests/MotoNomad.Tests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=unit-results.trx"
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 🌐 E2E TESTS
    - name: E2E Tests
      id: e2e
      run: |
        dotnet test MotoNomad.E2ETests/MotoNomad.E2ETests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=e2e-results.trx"
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 📊 TEST REPORT
    - name: Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/*-results.trx'
        reporter: dotnet-trx
        fail-on-error: false

    # 💬 PR COMMENT
    - name: PR Comment
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const format = '${{ steps.format.outputs.status }}';
          const build = '${{ steps.build.outputs.status }}';
          const unit = '${{ steps.unit.outputs.status }}';
          const e2e = '${{ steps.e2e.outputs.status }}';
          
          const ok = (s) => s === '0' ? '✅' : '❌';
          const label = (s) => s === '0' ? 'PASS' : 'FAIL';
          
          const allPass = format === '0' && build === '0' && unit === '0' && e2e === '0';
          
          const comment = `## 🔍 PR Check Results
          
          | Check | Status |
          |-------|--------|
          | 🎨 Format | ${ok(format)} ${label(format)} |
          | 🏗️ Build | ${ok(build)} ${label(build)} |
          | 🧪 Unit Tests | ${ok(unit)} ${label(unit)} |
          | 🌐 E2E Tests | ${ok(e2e)} ${label(e2e)} |
          
          ${allPass ? '✅ **All checks passed!**' : '⚠️ **Some checks failed**'}
          
          [View details →](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    # ❌ FAIL IF NEEDED
    - name: Check results
      if: |
        steps.format.outputs.status != '0' ||
        steps.build.outputs.status != '0' ||
        steps.unit.outputs.status != '0' ||
        steps.e2e.outputs.status != '0'
      run: |
        echo "Some checks failed!"
        exit 1