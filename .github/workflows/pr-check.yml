name: PR Check

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  pr-check:
    name: Lint, Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore
      run: dotnet restore

    # 🎨 FORMAT
    - name: Check formatting
      id: format
      run: |
        dotnet format --verify-no-changes --verbosity diagnostic
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 🏗️ BUILD
    - name: Build
      id: build
      run: |
        dotnet build --configuration Release --no-restore
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 🧪 UNIT TESTS
    - name: Unit Tests
      id: unit
      run: |
        dotnet test MotoNomad.Tests/MotoNomad.Tests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=unit-results.trx"
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 🚀 START BLAZOR APP (Background)
    - name: Start Blazor App
      run: |
        # 🔑 Inject OpenRouter API Key
        sed -i 's/#{OPENROUTER_API_KEY}#/${{ secrets.OPENROUTER_API_KEY }}/g' MotoNomad.App/wwwroot/appsettings.json
        
        cd MotoNomad.App
        dotnet run --configuration Release --no-build --urls "http://localhost:5000" &
        echo $! > blazor_app.pid
        cd ..
        # Wait for app to be ready
        timeout 60 bash -c 'until curl -f http://localhost:5000 > /dev/null 2>&1; do sleep 2; done' || (echo "App failed to start" && exit 1)
        echo "Blazor app started successfully"

    # 🎭 INSTALL PLAYWRIGHT
    - name: Install Playwright Browsers
      run: |
        dotnet build MotoNomad.E2ETests/MotoNomad.E2ETests.csproj --no-restore
        pwsh MotoNomad.E2ETests/bin/Release/net9.0/playwright.ps1 install --with-deps chromium

    # 🌐 E2E TESTS
    - name: E2E Tests
      id: e2e
      env:
        Supabase__TestUrl: ${{ secrets.SUPABASE_URL }}
        Supabase__TestPublicKey: ${{ secrets.SUPABASE_PUBLIC_KEY }}
        E2E__UserA__Email: ${{ secrets.USER_A_EMAIL }}
        E2E__UserA__Password: ${{ secrets.USER_A_PASSWORD }}
        E2E__UserB__Email: ${{ secrets.USER_B_EMAIL }}
        E2E__UserB__Password: ${{ secrets.USER_B_PASSWORD }}
        Application__BaseUrl: "http://localhost:5000"
      run: |
        dotnet test MotoNomad.E2ETests/MotoNomad.E2ETests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=e2e-results.trx"
        echo "status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # 🛑 STOP BLAZOR APP
    - name: Stop Blazor App
      if: always()
      run: |
        if [ -f MotoNomad.App/blazor_app.pid ]; then
          kill $(cat MotoNomad.App/blazor_app.pid) || true
          rm MotoNomad.App/blazor_app.pid
        fi

    # 📊 TEST REPORT
    - name: Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/*-results.trx'
        reporter: dotnet-trx
        fail-on-error: false

    # 💬 PR COMMENT
    - name: PR Comment
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const format = '${{ steps.format.outputs.status }}';
          const build = '${{ steps.build.outputs.status }}';
          const unit = '${{ steps.unit.outputs.status }}';
          const e2e = '${{ steps.e2e.outputs.status }}';
          
          const ok = (s) => s === '0' ? '✅' : '❌';
          const label = (s) => s === '0' ? 'PASS' : 'FAIL';
          
          const allPass = format === '0' && build === '0' && unit === '0' && e2e === '0';
          
          const comment = `## 🔍 PR Check Results
          
          | Check | Status |
          |-------|--------|
          | 🎨 Format | ${ok(format)} ${label(format)} |
          | 🏗️ Build | ${ok(build)} ${label(build)} |
          | 🧪 Unit Tests | ${ok(unit)} ${label(unit)} |
          | 🌐 E2E Tests | ${ok(e2e)} ${label(e2e)} |
          
          ${allPass ? '✅ **All checks passed!**' : '⚠️ **Some checks failed**'}
          
          [View details →](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    # ❌ FAIL IF NEEDED
    - name: Check results
      if: |
        steps.format.outputs.status != '0' ||
        steps.build.outputs.status != '0' ||
        steps.unit.outputs.status != '0' ||
        steps.e2e.outputs.status != '0'
      run: |
        echo "Some checks failed!"
        exit 1